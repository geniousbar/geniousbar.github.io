<!DOCTYPE html><html><head><meta charset="utf-8" /><meta content="IE=edge;chrome=1" http-equiv="X-UA-Compatible" /><meta content="initial-scale=1.0, user-scalable=no" name="viewport" /><title>crafting rails | 日常学习</title><meta description="crafting rails application  创建自己的render     rails plugins new pdf_render   gemspec, 之盾依赖， 作者、version， lib/pef_render.rb会被自动require（详细看bundler.io中的解释）   Gemfile, 直接引入gemspec，生命依赖关系   rails render 解析    # rails/actionpac k/lib/action_controller/metal..." /><link rel="alternate" type="application/atom+xml" title="Atom Feed" href="/feed.xml" /><link href="../../../../stylesheets/style-408849a5.css" rel="stylesheet" type="text/css" /><link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css" rel="stylesheet" /><link href="../../../../images/favicon-6c3f3d04.png" rel="icon" type="image/png" /><script src="../../../../javascripts/all-ae915a3d.js"></script></head><body><header><div class="top-menu"><div class="top-menu-wrapper"><div class="top-menu-list"><ul><li><a href="/">Home</a></li><li><a href="/archives/">Archives</a></li><li><a href="/tags/">Tags</a></li><li><a href="/by-year/">By Year</a></li></ul></div></div></div><h1 class="logo"><a href="/" title="日常学习"><span class="logo-text">日常学习</span></a></h1></header><main><article><h1 class="article-title">crafting rails</h1><div class="posted-date-wrapper"><i class="fa fa-clock-o"></i><span class="posted-date">July 28, 2017</span></div><div class="tag-labels"><a href="/tags/rails/"><small class="tag-label">rails</small></a><a href="/tags/ruby/"><small class="tag-label">ruby</small></a></div><hr class="article-header-separator" /><h2 id="crafting-rails-application">crafting rails application</h2>

<h3 id="创建自己的render">创建自己的render</h3>

<ul>
  <li>rails plugins new pdf_render</li>
  <li>gemspec, 之盾依赖， 作者、version， lib/pef_render.rb会被自动require（详细看bundler.io中的解释）</li>
  <li>Gemfile, 直接引入gemspec，生命依赖关系</li>
</ul>

<p>rails render 解析</p>

<div class="highlight"><pre class="highlight ruby"><code>  <span class="c1"># rails/actionpac k/lib/action_controller/metal/rendcers.rb</span>

  <span class="n">add</span> <span class="ss">:json</span> <span class="k">do</span> <span class="o">|</span><span class="n">json</span><span class="p">,</span> <span class="n">options</span><span class="o">|</span>
    <span class="n">json</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">to_json</span><span class="p">(</span><span class="n">options</span><span class="p">)</span> <span class="k">unless</span> <span class="n">json</span><span class="p">.</span><span class="nf">kind_of?</span><span class="p">(</span><span class="no">String</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">options</span><span class="p">[</span><span class="ss">:callback</span><span class="p">].</span><span class="nf">present?</span>
      <span class="nb">self</span><span class="p">.</span><span class="nf">content_type</span> <span class="o">||=</span> <span class="no">Mime</span><span class="o">::</span><span class="no">JS</span>
      <span class="s2">"</span><span class="si">#{</span><span class="n">options</span><span class="p">[</span><span class="ss">:callback</span><span class="p">]</span><span class="si">}</span><span class="s2">(</span><span class="si">#{</span><span class="n">json</span><span class="si">}</span><span class="s2">)"</span>
    <span class="k">else</span>
      <span class="nb">self</span><span class="p">.</span><span class="nf">content_type</span> <span class="o">|||=</span> <span class="no">Mime</span><span class="o">::</span><span class="no">JSON</span>
      <span class="nb">self</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="n">render</span> <span class="ss">json: </span><span class="vi">@post</span>
  <span class="n">json</span>  <span class="o">=&gt;</span> <span class="vi">@post</span><span class="c1"># json 指的是， block中的json的变量</span>
  <span class="c1"># 我们想提供的为</span>
  <span class="n">render</span> <span class="ss">pdf: </span><span class="s1">'contents'</span><span class="p">,</span> <span class="ss">template: </span><span class="s1">'path/to/template'</span>

  <span class="nb">require</span> <span class="s1">'prawn'</span>  <span class="c1"># prawn 提供 pdf的生成</span>
  <span class="n">pdf</span> <span class="o">=</span> <span class="no">Prawn</span><span class="o">::</span><span class="no">Document</span><span class="p">.</span><span class="nf">new</span>
  <span class="n">pdf</span><span class="p">.</span><span class="nf">text</span><span class="p">(</span><span class="s1">'a string to pdf'</span><span class="p">)</span>
  <span class="n">pdf</span><span class="p">.</span><span class="nf">render_file</span><span class="p">(</span><span class="s1">'sample.pdf'</span><span class="p">)</span>


  <span class="c1"># lib/pdf_render.rb</span>
  <span class="nb">require</span> <span class="s1">'prawn'</span>
  <span class="no">ActionController</span><span class="o">::</span><span class="no">Renderers</span><span class="p">.</span><span class="nf">add</span> <span class="ss">:pdf</span> <span class="k">do</span> <span class="o">|</span><span class="n">filename</span><span class="p">,</span> <span class="n">options</span><span class="o">|</span>
    <span class="n">pdf</span> <span class="o">=</span> <span class="no">Prawn</span><span class="o">::</span><span class="no">Document</span><span class="p">.</span><span class="nf">new</span>
    <span class="n">pdf</span><span class="p">.</span><span class="nf">text</span> <span class="o">=</span> <span class="n">render_to_string</span><span class="p">(</span><span class="n">options</span><span class="p">)</span>
    <span class="n">send_data</span><span class="p">(</span><span class="n">pdf</span><span class="p">.</span><span class="nf">render</span><span class="p">,</span> <span class="ss">filename: </span><span class="s2">"</span><span class="si">#{</span><span class="n">filename</span><span class="si">}</span><span class="s2">.pdf"</span><span class="p">,</span> <span class="ss">diposition: </span><span class="s2">"attachment"</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="c1"># rails 如何设定正确的respon中的content type？</span>
  <span class="no">Mime</span><span class="o">::</span><span class="no">Type</span><span class="p">.</span><span class="nf">register</span> <span class="s2">"application/pdf"</span><span class="p">,</span> <span class="ss">:pdf</span><span class="p">,</span> <span class="p">[],</span> <span class="sx">%w(pdf)</span>
</code></pre></div>
<p>rails render stack</p>

<div class="highlight"><pre class="highlight plaintext"><code>   AbstractController::Rendering.render
   |
   |-- _normalize_render
   |      |-- _normalize_args
   |      |-- _normalize_opions
   |-- ActionView::Rending.render_to_body
          |-- _proccess_options
          |-- _render_template
                  |-- context = view_context_class.new(view_renderer, view_assigns, self)
                  |-- ActionView::Renderer.new(lookup_context).render(context, option)
                      |-- Renderer.render_template(context, options)
                          |-- TemplateRenderer.new(@lookup_context).render(context, options)

  其中, 大部分的都是在ActionController::Base 中include进去的，所以。所有方法都是在controller中执行的
    def view_assigns
      protected_vars = _protected_ivars
      variables      = instance_variables

      variables.reject! { || sprotected_vars.include?  }
      svariables.each_with_object({}) { |name, hash|
        hash[name.slice(1, name.length)] = instance_variable_get(name)
      }
    end
    获取controller中所有的实例变量, 传递到 context中
</code></pre></div>
<h3 id="通过active-model建立自己的模型">通过Active Model建立自己的模型</h3>

<ol>
  <li>form_helper</li>
</ol>

<div class="highlight"><pre class="highlight plaintext"><code>  form_for(record, options)
  |-- builder = instantiate_builder(object_name, record, options)
      |-- builder = options[:builder] || default_form_builder_class # ActionView::Helpers::FormBuilder
      |-- builder.new(object_name, object, self, options) # self is ActionView::Base instance
  |-- output = capture(builder, &amp;block) # form_for中的内部dom
      |-- yield(builder)
        |-- Tags::TextField.new("data_bank", :title, self, {object: object}).render
          |-- options["value"] = options.fetch("value") { value_before_type_cast(object) }
            |-- value_before_type_cast # 从object获取method_name的数值
  |-- form_tag_with_body(html_options, output) # 构建真正的form dom
</code></pre></div>
<p><strong>所以rails中的文档有很明确的拓展方法:</strong></p>

<div class="highlight"><pre class="highlight ruby"><code>  <span class="k">class</span> <span class="nc">MyFormBuilder</span> <span class="o">&lt;</span> <span class="no">ActionView</span><span class="o">::</span><span class="no">Helpers</span><span class="o">::</span><span class="no">FormBuilder</span>
    <span class="k">def</span> <span class="nf">div_radio_button</span><span class="p">(</span><span class="nb">method</span><span class="p">,</span> <span class="n">tag_value</span><span class="p">,</span> <span class="n">options</span> <span class="o">=</span> <span class="p">{})</span>
      <span class="vi">@template</span><span class="p">.</span><span class="nf">content_tag</span><span class="p">(</span><span class="ss">:div</span><span class="p">,</span>
        <span class="vi">@template</span><span class="p">.</span><span class="nf">radio_button</span><span class="p">(</span>
          <span class="vi">@object_name</span><span class="p">,</span> <span class="nb">method</span><span class="p">,</span> <span class="n">tag_value</span><span class="p">,</span> <span class="n">objectify_options</span><span class="p">(</span><span class="n">options</span><span class="p">)</span>
        <span class="p">)</span>
      <span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="c1"># The above code creates a new method +div_radio_button+ which wraps a div</span>
  <span class="c1"># around the new radio button. Note that when options are passed in, you</span>
  <span class="c1"># must call +objectify_options+ in order for the model object to get</span>
  <span class="c1"># correctly passed to the method. If +objectify_options+ is not called,</span>
  <span class="c1"># then the newly created helper will not be linked back to the model.</span>
  <span class="c1">#   &lt;%= form_for @person, :builder =&gt; MyFormBuilder do |f| %&gt;</span>
  <span class="c1">#     I am a child: &lt;%= f.div_radio_button(:admin, "child") %&gt;</span>
  <span class="c1">#     I am an adult: &lt;%= f.div_radio_button(:admin, "adult") %&gt;</span>
  <span class="c1">#   &lt;% end -%&gt;</span>

</code></pre></div>
<p>使用继承类，定义自定义的方法， 其他的自然使用继承的方法调用</p>

<blockquote>
  <ol>
    <li>如何扩展 FormBuilder， 2： FormBuilder 在编辑时候的，默认值，是如何取到的</li>
  </ol>
</blockquote>
<div class="social"></div></article></main><footer><div class="footer-wrapper"><div class="author"><div class="image-wrapper"><a href="/author/"><img alt="author" src="../../../../images/profile-1e71686a.png" /></a></div></div><div class="copyright"><i class="fa fa-copyright"></i> 2017 <a href="/">日常学习</a> - geniousbar</div></div></footer></body></html>